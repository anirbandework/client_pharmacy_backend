# Purchase Invoice Analyzer - Testing Guide

This guide provides comprehensive testing instructions for the Purchase Invoice Analyzer system.

## ðŸš€ Quick Start

### 1. Setup and Sample Data

```bash
# Create sample data
python create_sample_invoice_data.py

# Start the server
./start.sh
```

### 2. Access API Documentation
Visit: http://localhost:8000/docs

## ðŸ§ª Test Scenarios

### Scenario 1: Complete Invoice Lifecycle

#### Step 1: Create a Purchase Invoice
```bash
curl -X POST \"http://localhost:8000/api/invoices/\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"invoice_number\": \"TEST-001\",\n    \"supplier_name\": \"Test Pharmaceuticals\",\n    \"invoice_date\": \"2024-01-15\",\n    \"received_date\": \"2024-01-16\",\n    \"items\": [\n      {\n        \"item_code\": \"TEST001\",\n        \"item_name\": \"Test Medicine 100mg\",\n        \"batch_number\": \"BATCH001\",\n        \"purchased_quantity\": 100,\n        \"unit_cost\": 5.00,\n        \"selling_price\": 8.00,\n        \"expiry_date\": \"2025-01-15\"\n      },\n      {\n        \"item_code\": \"TEST002\",\n        \"item_name\": \"Test Syrup 200ml\",\n        \"purchased_quantity\": 50,\n        \"unit_cost\": 25.00,\n        \"selling_price\": 40.00,\n        \"expiry_date\": \"2024-06-15\"\n      }\n    ]\n  }'\n```\n\n**Expected Result:**\n- Invoice created with status \"received\" and color \"red\"\n- Automatic expiry alerts generated for items expiring within 1 year\n- Monthly summary updated\n\n#### Step 2: Record Sales\n```bash\n# Record sale for first item\ncurl -X POST \"http://localhost:8000/api/invoices/sales\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"item_id\": 1,\n    \"quantity_sold\": 30,\n    \"sale_price\": 8.00,\n    \"customer_type\": \"regular\"\n  }'\n\n# Record more sales to change invoice color\ncurl -X POST \"http://localhost:8000/api/invoices/sales\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"item_id\": 1,\n    \"quantity_sold\": 50,\n    \"sale_price\": 8.00,\n    \"customer_type\": \"walk-in\"\n  }'\n```\n\n**Expected Result:**\n- Item quantities updated\n- Movement rate calculated\n- Invoice color changes from red â†’ yellow â†’ green as sales increase\n\n#### Step 3: Check Invoice Status\n```bash\ncurl \"http://localhost:8000/api/invoices/1\"\n```\n\n**Expected Result:**\n```json\n{\n  \"id\": 1,\n  \"invoice_number\": \"TEST-001\",\n  \"sold_percentage\": 80.0,\n  \"status\": \"partial\",\n  \"color_code\": \"yellow\",\n  \"has_expiring_items\": true\n}\n```\n\n### Scenario 2: Expiry Alert Management\n\n#### Step 1: Get Expiry Alerts\n```bash\ncurl \"http://localhost:8000/api/invoices/expiry/alerts?days_ahead=365\"\n```\n\n#### Step 2: Acknowledge Alert\n```bash\ncurl -X PUT \"http://localhost:8000/api/invoices/expiry/alerts/1/acknowledge\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"acknowledged_by\": \"pharmacist_john\"}'\n```\n\n### Scenario 3: Monthly Analytics\n\n#### Get Current Month Analytics\n```bash\ncurl \"http://localhost:8000/api/invoices/analytics/2024/1\"\n```\n\n**Expected Result:**\n```json\n{\n  \"total_invoices\": 5,\n  \"total_value\": 15000.50,\n  \"sold_out_invoices\": 1,\n  \"partial_invoices\": 2,\n  \"unsold_invoices\": 2,\n  \"average_sold_percentage\": 45.2,\n  \"expiring_alerts\": 3,\n  \"top_moving_items\": [...],\n  \"slow_moving_items\": [...]\n}\n```\n\n### Scenario 4: AI Analytics Testing\n\n#### Comprehensive AI Analysis\n```bash\ncurl \"http://localhost:8000/api/invoices/ai-analytics/comprehensive\"\n```\n\n#### Item Movement Analysis (5 Parameters)\n```bash\ncurl \"http://localhost:8000/api/invoices/ai-analytics/item-movement/PARA500\"\n```\n\n**Expected Result:**\n```json\n{\n  \"velocity\": 2.5,\n  \"seasonality\": 1.0,\n  \"profitability\": 60.0,\n  \"expiry_risk\": 0.2,\n  \"demand_consistency\": 0.8,\n  \"ai_prediction\": {\n    \"category\": \"medium_moving\",\n    \"recommendation\": \"Maintain current stock levels\"\n  }\n}\n```\n\n#### Stock Predictions\n```bash\ncurl \"http://localhost:8000/api/invoices/ai-analytics/stock-predictions?months_ahead=3\"\n```\n\n### Scenario 5: Dashboard Testing\n\n```bash\ncurl \"http://localhost:8000/api/invoices/dashboard\"\n```\n\n**Expected Result:**\n- Current month summary with color coding\n- Top 10 pending expiry alerts\n- Last 5 invoices with status\n- Top 10 moving items analytics\n- AI insights and recommendations\n\n## ðŸŽ¯ Color Coding Tests\n\n### Test Invoice Color Changes\n\n1. **Red Invoice (0-29% sold)**\n   ```bash\n   # Create invoice and sell <30%\n   # Should remain red\n   ```\n\n2. **Yellow Invoice (30-94% sold)**\n   ```bash\n   # Sell 30-94% of total quantity\n   # Should turn yellow\n   ```\n\n3. **Green Invoice (95%+ sold)**\n   ```bash\n   # Sell 95%+ of total quantity\n   # Should turn green\n   ```\n\n### Test Monthly Color Coding\n\n1. **Green Month**: All invoices sold out\n2. **Yellow Month**: 70%+ invoices are green/yellow\n3. **Red Month**: <70% invoices performing well\n\n## ðŸš¨ Expiry Alert Tests\n\n### Test Alert Generation\n\n1. **45-Day Alert**\n   ```bash\n   # Create item expiring in 30 days\n   # Should generate high priority alert\n   ```\n\n2. **1-Year Alert**\n   ```bash\n   # Create item expiring in 300 days\n   # Should generate low priority alert\n   ```\n\n3. **Expired Alert**\n   ```bash\n   # Create item with past expiry date\n   # Should generate critical alert\n   ```\n\n## ðŸ“Š Performance Tests\n\n### Load Testing\n\n```bash\n# Test with multiple invoices\nfor i in {1..50}; do\n  curl -X POST \"http://localhost:8000/api/invoices/\" \\\n    -H \"Content-Type: application/json\" \\\n    -d \"$(cat sample_invoice.json)\"\ndone\n```\n\n### Analytics Performance\n\n```bash\n# Test analytics with large dataset\ntime curl \"http://localhost:8000/api/invoices/analytics/2024/1\"\ntime curl \"http://localhost:8000/api/invoices/ai-analytics/comprehensive\"\n```\n\n## ðŸ” Edge Case Tests\n\n### Test Error Handling\n\n1. **Invalid Invoice Data**\n   ```bash\n   curl -X POST \"http://localhost:8000/api/invoices/\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"invalid\": \"data\"}'\n   ```\n   **Expected**: 400 Bad Request\n\n2. **Duplicate Invoice Number**\n   ```bash\n   # Create invoice with existing invoice_number\n   ```\n   **Expected**: 400 Bad Request\n\n3. **Overselling Item**\n   ```bash\n   curl -X POST \"http://localhost:8000/api/invoices/sales\" \\\n     -d '{\"item_id\": 1, \"quantity_sold\": 999999}'\n   ```\n   **Expected**: 400 \"Insufficient stock\"\n\n4. **Non-existent Item Sale**\n   ```bash\n   curl -X POST \"http://localhost:8000/api/invoices/sales\" \\\n     -d '{\"item_id\": 999999, \"quantity_sold\": 10}'\n   ```\n   **Expected**: 400 \"Item not found\"\n\n## ðŸ¤– AI Integration Tests\n\n### Test with Gemini API Key\n\n1. **Set Environment Variable**\n   ```bash\n   export GEMINI_API_KEY=\"your_api_key_here\"\n   ```\n\n2. **Test AI Analytics**\n   ```bash\n   curl \"http://localhost:8000/api/invoices/ai-analytics/comprehensive\"\n   ```\n   **Expected**: Rich AI insights with patterns and recommendations\n\n### Test without AI (Fallback)\n\n1. **Remove API Key**\n   ```bash\n   unset GEMINI_API_KEY\n   ```\n\n2. **Test Analytics**\n   ```bash\n   curl \"http://localhost:8000/api/invoices/ai-analytics/comprehensive\"\n   ```\n   **Expected**: Basic analytics without AI insights\n\n## ðŸ“± Frontend Integration Tests\n\n### Test CORS\n\n```javascript\n// From browser console at localhost:3000\nfetch('http://localhost:8000/api/invoices/dashboard')\n  .then(response => response.json())\n  .then(data => console.log(data));\n```\n\n### Test Real-time Updates\n\n1. Open dashboard in browser\n2. Record sales via API\n3. Refresh dashboard\n4. Verify color changes and updates\n\n## ðŸ”§ Database Tests\n\n### Test Data Integrity\n\n```sql\n-- Check invoice calculations\nSELECT \n  invoice_number,\n  total_amount,\n  sold_percentage,\n  color_code\nFROM purchase_invoices;\n\n-- Check expiry alerts\nSELECT \n  alert_type,\n  message,\n  priority,\n  is_acknowledged\nFROM expiry_alerts;\n\n-- Check monthly summaries\nSELECT \n  year,\n  month,\n  total_invoices,\n  month_color,\n  overall_sold_percentage\nFROM monthly_invoice_summary;\n```\n\n## ðŸ“‹ Test Checklist\n\n### Basic Functionality\n- [ ] Create purchase invoice\n- [ ] Record item sales\n- [ ] Update invoice status and color\n- [ ] Generate expiry alerts\n- [ ] Calculate monthly summaries\n\n### Color Coding\n- [ ] Red invoices (0-29% sold)\n- [ ] Yellow invoices (30-94% sold)\n- [ ] Green invoices (95%+ sold)\n- [ ] Monthly color calculation\n\n### Expiry Management\n- [ ] 45-day alerts generated\n- [ ] 1-year alerts generated\n- [ ] Expired item alerts\n- [ ] Alert acknowledgment\n\n### Analytics\n- [ ] Monthly analytics calculation\n- [ ] Movement rate calculation\n- [ ] Demand categorization\n- [ ] Top/slow moving items\n\n### AI Features\n- [ ] 5-parameter analysis\n- [ ] Movement pattern detection\n- [ ] Stock predictions\n- [ ] Business insights\n\n### API Endpoints\n- [ ] All endpoints return correct status codes\n- [ ] Error handling works properly\n- [ ] Response formats match schemas\n- [ ] Authentication (if enabled)\n\n### Performance\n- [ ] Dashboard loads quickly\n- [ ] Analytics calculations complete in <5s\n- [ ] Large dataset handling\n- [ ] Concurrent request handling\n\n## ðŸ› Common Issues & Solutions\n\n### Issue: AI Analytics Not Working\n**Solution**: Check GEMINI_API_KEY environment variable\n\n### Issue: Color Not Updating\n**Solution**: Verify sales are being recorded and invoice status is recalculated\n\n### Issue: Expiry Alerts Not Showing\n**Solution**: Check expiry_date format and alert generation logic\n\n### Issue: Performance Slow\n**Solution**: Add database indexes, implement caching\n\n## ðŸ“Š Success Metrics\n\n- âœ… All API endpoints return 200/201 for valid requests\n- âœ… Color coding updates automatically with sales\n- âœ… Expiry alerts generated within 1 second of invoice creation\n- âœ… Monthly summaries calculated correctly\n- âœ… AI analytics provide meaningful insights\n- âœ… Dashboard loads in <3 seconds\n- âœ… System handles 100+ invoices without performance issues\n\n---\n\n**Happy Testing! ðŸŽ‰**\n\nFor issues or questions, check the main README.md or create a GitHub issue.