#!/usr/bin/env python3
\"\"\"
Sample data script for Purchase Invoice Analyzer
Creates realistic pharmacy purchase invoices with items and demonstrates the system functionality.
\"\"\"

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from datetime import date, timedelta
from sqlalchemy.orm import Session
from app.database.database import get_db, engine
from modules.invoice_analyzer.models import Base
from modules.invoice_analyzer.service import PurchaseInvoiceService
from modules.invoice_analyzer.schemas import PurchaseInvoiceCreate, PurchaseInvoiceItemCreate, ItemSaleCreate

# Create tables
Base.metadata.create_all(bind=engine)

def create_sample_invoices():
    \"\"\"Create sample purchase invoices with realistic pharmacy data\"\"\"
    
    db = next(get_db())
    
    # Sample suppliers
    suppliers = [
        \"MediSupply Pharmaceuticals\",
        \"HealthCare Distributors Ltd\",
        \"PharmaCorp India\",
        \"Global Medicine Co\",
        \"Regional Drug Suppliers\"
    ]
    
    # Sample medicines with realistic data
    medicines = [
        {\"code\": \"PARA500\", \"name\": \"Paracetamol 500mg\", \"cost\": 2.50, \"price\": 4.00, \"expiry_months\": 24},\n        {\"code\": \"AMOX250\", \"name\": \"Amoxicillin 250mg\", \"cost\": 8.00, \"price\": 12.00, \"expiry_months\": 18},\n        {\"code\": \"CEFI200\", \"name\": \"Cefixime 200mg\", \"cost\": 15.00, \"price\": 22.00, \"expiry_months\": 20},\n        {\"code\": \"AZITH500\", \"name\": \"Azithromycin 500mg\", \"cost\": 25.00, \"price\": 35.00, \"expiry_months\": 24},\n        {\"code\": \"OMEP20\", \"name\": \"Omeprazole 20mg\", \"cost\": 12.00, \"price\": 18.00, \"expiry_months\": 30},\n        {\"code\": \"METRO400\", \"name\": \"Metronidazole 400mg\", \"cost\": 6.00, \"price\": 9.00, \"expiry_months\": 36},\n        {\"code\": \"DICLO50\", \"name\": \"Diclofenac 50mg\", \"cost\": 4.00, \"price\": 7.00, \"expiry_months\": 24},\n        {\"code\": \"LOSA50\", \"name\": \"Losartan 50mg\", \"cost\": 18.00, \"price\": 28.00, \"expiry_months\": 36},\n        {\"code\": \"METF500\", \"name\": \"Metformin 500mg\", \"cost\": 3.50, \"price\": 6.00, \"expiry_months\": 48},\n        {\"code\": \"ATOR20\", \"name\": \"Atorvastatin 20mg\", \"cost\": 22.00, \"price\": 32.00, \"expiry_months\": 30},\n        {\"code\": \"VITA_B\", \"name\": \"Vitamin B Complex\", \"cost\": 8.50, \"price\": 14.00, \"expiry_months\": 12},  # Short expiry\n        {\"code\": \"COUGH_SYR\", \"name\": \"Cough Syrup 100ml\", \"cost\": 45.00, \"price\": 65.00, \"expiry_months\": 6},  # Very short expiry\n        {\"code\": \"INSULIN\", \"name\": \"Insulin Injection\", \"cost\": 180.00, \"price\": 250.00, \"expiry_months\": 8},  # Short expiry, expensive\n        {\"code\": \"ASPIRIN\", \"name\": \"Aspirin 75mg\", \"cost\": 1.50, \"price\": 3.00, \"expiry_months\": 60},  # Long expiry\n        {\"code\": \"BANDAGE\", \"name\": \"Medical Bandage\", \"cost\": 12.00, \"price\": 20.00, \"expiry_months\": 120}  # Very long expiry\n    ]\n    \n    print(\"Creating sample purchase invoices...\")\n    \n    # Create invoices for the last 3 months\n    invoices_created = 0\n    \n    for month_offset in range(3, 0, -1):  # 3 months ago to current\n        invoice_date = date.today() - timedelta(days=30 * month_offset)\n        \n        # Create 3-5 invoices per month\n        for invoice_num in range(1, 5):\n            try:\n                # Select random supplier and medicines\n                supplier = suppliers[invoice_num % len(suppliers)]\n                \n                # Create invoice items (3-8 items per invoice)\n                items = []\n                selected_medicines = medicines[invoice_num * 2:(invoice_num * 2) + 6]  # Different items per invoice\n                \n                for i, med in enumerate(selected_medicines):\n                    # Calculate expiry date\n                    expiry_date = invoice_date + timedelta(days=30 * med[\"expiry_months\"])\n                    \n                    # Vary quantities based on medicine type\n                    if \"Injection\" in med[\"name\"] or \"Insulin\" in med[\"name\"]:\n                        quantity = 20 + (i * 5)  # Smaller quantities for injections\n                    elif \"Syrup\" in med[\"name\"]:\n                        quantity = 50 + (i * 10)  # Medium quantities for syrups\n                    else:\n                        quantity = 100 + (i * 50)  # Larger quantities for tablets\n                    \n                    items.append(PurchaseInvoiceItemCreate(\n                        item_code=med[\"code\"],\n                        item_name=med[\"name\"],\n                        batch_number=f\"BATCH{invoice_date.strftime('%Y%m')}{invoice_num:02d}{i:02d}\",\n                        purchased_quantity=quantity,\n                        unit_cost=med[\"cost\"],\n                        selling_price=med[\"price\"],\n                        expiry_date=expiry_date\n                    ))\n                \n                # Create invoice\n                invoice_data = PurchaseInvoiceCreate(\n                    invoice_number=f\"INV-{invoice_date.strftime('%Y%m')}-{invoice_num:03d}\",\n                    supplier_name=supplier,\n                    invoice_date=invoice_date,\n                    received_date=invoice_date + timedelta(days=1),\n                    items=items\n                )\n                \n                invoice = PurchaseInvoiceService.create_invoice(db, invoice_data, shop_id=1)\n                invoices_created += 1\n                \n                print(f\"âœ“ Created invoice {invoice.invoice_number} with {len(items)} items\")\n                \n                # Simulate some sales for older invoices (to show color coding)\n                if month_offset >= 2:  # Only for invoices 2+ months old\n                    simulate_sales(db, invoice, month_offset)\n                \n            except Exception as e:\n                print(f\"âœ— Error creating invoice: {str(e)}\")\n                continue\n    \n    print(f\"\\nâœ… Successfully created {invoices_created} purchase invoices\")\n    \n    # Show summary\n    show_summary(db)\n\ndef simulate_sales(db: Session, invoice, month_offset: int):\n    \"\"\"Simulate sales for an invoice to demonstrate color coding\"\"\"\n    \n    # Simulate different sales patterns based on month\n    if month_offset == 3:  # 3 months old - should be mostly sold\n        sale_percentage = 0.85  # 85% sold (Yellow/Green)\n    elif month_offset == 2:  # 2 months old - partially sold\n        sale_percentage = 0.45  # 45% sold (Yellow)\n    else:\n        sale_percentage = 0.15  # 15% sold (Red)\n    \n    for item in invoice.items:\n        try:\n            # Calculate quantity to sell\n            quantity_to_sell = item.purchased_quantity * sale_percentage\n            \n            if quantity_to_sell > 0:\n                # Create multiple sales over time\n                sales_count = min(5, int(quantity_to_sell / 10)) or 1\n                quantity_per_sale = quantity_to_sell / sales_count\n                \n                for _ in range(sales_count):\n                    if item.remaining_quantity >= quantity_per_sale:\n                        sale_data = ItemSaleCreate(\n                            item_id=item.id,\n                            quantity_sold=quantity_per_sale,\n                            sale_price=item.selling_price,\n                            customer_type=\"regular\" if _ % 2 == 0 else \"walk-in\"\n                        )\n                        \n                        PurchaseInvoiceService.record_sale(db, sale_data)\n        \n        except Exception as e:\n            print(f\"  Warning: Could not simulate sale for {item.item_code}: {str(e)}\")\n            continue\n\ndef show_summary(db: Session):\n    \"\"\"Show a summary of created data\"\"\"\n    \n    from modules.invoice_analyzer.models import PurchaseInvoice, PurchaseInvoiceItem, ItemSale\n    \n    # Count invoices by color\n    invoices = db.query(PurchaseInvoice).all()\n    \n    green_count = len([inv for inv in invoices if inv.color_code == \"green\"])\n    yellow_count = len([inv for inv in invoices if inv.color_code == \"yellow\"])\n    red_count = len([inv for inv in invoices if inv.color_code == \"red\"])\n    \n    total_items = db.query(PurchaseInvoiceItem).count()\n    total_sales = db.query(ItemSale).count()\n    \n    # Items expiring soon\n    expiring_soon = db.query(PurchaseInvoiceItem).filter(\n        PurchaseInvoiceItem.days_to_expiry <= 45,\n        PurchaseInvoiceItem.days_to_expiry > 0\n    ).count()\n    \n    print(\"\\nðŸ“Š SUMMARY\")\n    print(\"=\" * 50)\n    print(f\"Total Invoices: {len(invoices)}\")\n    print(f\"  ðŸŸ¢ Green (Sold Out): {green_count}\")\n    print(f\"  ðŸŸ¡ Yellow (Partial): {yellow_count}\")\n    print(f\"  ðŸ”´ Red (Unsold): {red_count}\")\n    print(f\"\\nTotal Items: {total_items}\")\n    print(f\"Total Sales Recorded: {total_sales}\")\n    print(f\"Items Expiring Soon (45 days): {expiring_soon}\")\n    \n    # Show some specific examples\n    print(\"\\nðŸ“‹ SAMPLE INVOICES\")\n    print(\"-\" * 50)\n    for invoice in invoices[:5]:\n        status_emoji = {\"green\": \"ðŸŸ¢\", \"yellow\": \"ðŸŸ¡\", \"red\": \"ðŸ”´\"}[invoice.color_code]\n        print(f\"{status_emoji} {invoice.invoice_number} - {invoice.sold_percentage:.1f}% sold - {invoice.supplier_name}\")\n    \n    print(\"\\nðŸš¨ EXPIRY ALERTS\")\n    print(\"-\" * 50)\n    expiring_items = db.query(PurchaseInvoiceItem).filter(\n        PurchaseInvoiceItem.days_to_expiry <= 45,\n        PurchaseInvoiceItem.days_to_expiry > 0\n    ).order_by(PurchaseInvoiceItem.days_to_expiry).limit(5).all()\n    \n    for item in expiring_items:\n        urgency = \"ðŸ”´\" if item.days_to_expiry <= 15 else \"ðŸŸ¡\"\n        print(f\"{urgency} {item.item_name} - {item.days_to_expiry} days to expiry - {item.remaining_quantity} units left\")\n    \n    print(\"\\nâœ… Sample data creation completed!\")\n    print(\"\\nðŸš€ You can now test the API endpoints:\")\n    print(\"   GET /api/invoices/dashboard\")\n    print(\"   GET /api/invoices/monthly/2024/1\")\n    print(\"   GET /api/invoices/expiry/alerts\")\n    print(\"   GET /api/invoices/ai-analytics/comprehensive\")\n\nif __name__ == \"__main__\":\n    print(\"ðŸ¥ Purchase Invoice Analyzer - Sample Data Creator\")\n    print(\"=\" * 60)\n    \n    try:\n        create_sample_invoices()\n    except Exception as e:\n        print(f\"âŒ Error: {str(e)}\")\n        import traceback\n        traceback.print_exc()